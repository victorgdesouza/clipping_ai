<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios de Desempenho</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification-popup { position: fixed; top: 20px; right: 20px; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; z-index: 10000; transform: translateX(120%); transition: transform 0.3s ease-in-out; }
        .notification-popup.show { transform: translateX(0); }
        .loader-small { border: 2px solid #f3f3f3; border-top: 2px solid #4f46e5; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        .report-content-screen h2 { font-size: 1.75rem; font-weight: 700; border-bottom: 2px solid #333; padding-bottom: 0.5rem; margin-bottom: 1.5rem; color: #111827; }
        .report-content-screen .h2-first { margin-top: 0; }
        .report-content-screen h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.75rem; margin-top: 1.25rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem; }
        .report-content-screen p, .report-content-screen li { margin-bottom: 1rem; line-height: 1.6; }
        .report-content-screen ul { list-style-position: inside; }
        .report-content-screen li { padding-left: 1rem; }
        .page-break { page-break-before: always; }
        .highlight {
            transition: background-color 0.5s ease-in-out;
            background-color: #fef9c3 !important;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="loading-screen" class="flex items-center justify-center min-h-screen"><div class="loader"></div></div>
    <div id="main-content" class="container mx-auto p-4 w-full" style="display: none;">
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
            <header class="flex flex-wrap justify-between items-center border-b pb-4 mb-6">
                <div><h1 class="text-3xl font-bold text-gray-800">Gerador de Relatórios</h1><p id="user-email" class="text-sm text-gray-500"></p></div>
                <a href="dashboard.html" class="text-blue-500 hover:underline">Voltar ao Dashboard</a>
            </header>
            <main>
                <section class="bg-gray-50 p-4 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4">1. Filtros do Relatório</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="cliente-select-report" class="p-2 border rounded-md w-full" required><option value="">Selecione um Cliente</option></select>
                        <input type="month" id="month-select-report" class="p-2 border rounded-md w-full text-gray-500" required>
                    </div>
                    <div id="comparison-selector-div" class="mt-4 hidden">
                        <label for="comparison-report-select" class="block text-sm font-medium text-gray-700">Comparar com Relatório Salvo (opcional)</label>
                        <select id="comparison-report-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="">Não comparar</option>
                        </select>
                    </div>
                </section>
                
                <section id="saved-reports-section" class="mt-6 hidden">
                    <h2 class="text-2xl font-semibold mb-4">Histórico de Relatórios Salvos</h2>
                    <div id="saved-reports-list" class="bg-gray-50 p-4 rounded-lg space-y-2"></div>
                </section>
                
                <section class="mt-6 space-y-4 bg-gray-50 p-4 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-2">2. Conteúdo Editável</h2>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                             <label for="overview-input" class="block text-sm font-medium text-gray-700">Resumo do Mês (Overview)</label>
                             <button id="suggest-overview-btn" class="bg-indigo-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-indigo-600 flex items-center gap-2">Sugerir com IA</button>
                        </div>
                        <textarea id="overview-input" rows="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                    </div>
                    <div>
                         <div class="flex justify-between items-center mb-1">
                            <label for="next-steps-input" class="block text-sm font-medium text-gray-700">Próximos Passos</label>
                            <button id="suggest-next-steps-btn" class="bg-teal-500 text-white text-xs font-bold py-1 px-3 rounded-md hover:bg-teal-600 flex items-center gap-2">Sugerir com IA</button>
                        </div>
                        <textarea id="next-steps-input" rows="8" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                    </div>
                </section>
                <section class="mt-6">
                    <button id="generate-report-btn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-md hover:bg-purple-700 text-lg">Gerar Relatório e Pré-visualizar</button>
                </section>
                <section id="report-editor-wrapper" class="mt-6 hidden">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold text-gray-700">3. Pré-visualização do Relatório</h2>
                        <div class="flex gap-2">
                            <button id="save-report-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 flex items-center gap-2">Salvar Pré-visualização</button>
                            <button id="export-pdf-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600 flex items-center gap-2">Exportar para PDF</button>
                        </div>
                    </div>
                    <div id="report-editor" class="p-8 bg-white border rounded-lg report-content-screen"></div>
                </section>
                <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
                    <div class="relative bg-white p-2 rounded-lg max-w-4xl max-h-full shadow-2xl">
                        <button id="modal-close-btn" class="absolute -top-3 -right-3 bg-white rounded-full h-8 w-8 text-black font-bold text-2xl flex items-center justify-center">&times;</button>
                        <img id="modal-image" src="" alt="Clipping Ampliado" class="w-full h-auto object-contain max-h-[90vh]">
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="notification-popup" class="notification-popup"><p id="notification-message"></p></div>

    <script>
        const supabaseUrl = 'https://ojejoifgyledbsesipdr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qZWpvaWZneWxlZGJzZXNpcGRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MDU5NjUsImV4cCI6MjA2NTE4MTk2NX0.MrGJIa2xIAW8OUQ5PiUXAFXgT9-rHdwgw_SRZcZ6g_Q';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        let currentUser = null, userProfile = null, chartInstances = {}, lastGeneratedData = null;

        function showNotification(message, type = 'success') {
            const popup = document.getElementById('notification-popup');
            if (!popup) return;
            popup.querySelector('p').textContent = message;
            popup.className = 'notification-popup show';
            popup.style.backgroundColor = type === 'error' ? '#ef4444' : '#22c55e';
            setTimeout(() => { popup.classList.remove('show'); }, 3500);
        }

        async function handleAuth() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) { window.location.href = '/index.html'; return; }
            currentUser = session.user;
            const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', currentUser.id).single();
            userProfile = profile;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            initializePage();
        }

        function initializePage() {
            populateClientSelect();
            const today = new Date();
            document.getElementById('month-select-report').value = today.toISOString().substring(0, 7);
            document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDFwithPdfMake);
            document.getElementById('save-report-btn').addEventListener('click', saveReport);
            document.getElementById('suggest-overview-btn').addEventListener('click', suggestOverviewWithAI);
            document.getElementById('suggest-next-steps-btn').addEventListener('click', suggestNextStepsWithAI);
            document.getElementById('cliente-select-report').addEventListener('change', (e) => {
                fetchSavedReports(e.target.value);
            });
            const imageModal = document.getElementById('image-modal');
            document.getElementById('modal-close-btn').addEventListener('click', () => imageModal.classList.add('hidden'));
            imageModal.addEventListener('click', (e) => { if (e.target === imageModal) imageModal.classList.add('hidden'); });
        }

        async function populateClientSelect() {
            let query = supabaseClient.from('clientes').select('id, name, logo_url, descricao_negocio, objetivo_principal, publico_alvo').order('name');
            const userMode = sessionStorage.getItem('userMode');

            if (userProfile && userProfile.role === 'atendimento' && userMode === 'atendimento') {
                 const { data: assignments, error: assignmentsError } = await supabaseClient.from('atendimento_assignments').select('cliente_id').eq('user_id', currentUser.id);
                 if(assignmentsError) { console.error(assignmentsError); return; }
                 
                 if(assignments.length > 0) {
                    const clientIds = assignments.map(a => a.cliente_id);
                    query = query.in('id', clientIds);
                 } else {
                    const selectElement = document.getElementById('cliente-select-report');
                    selectElement.innerHTML = '<option value="">Nenhum cliente na sua carteira</option>';
                    return;
                 }
            }
            const { data, error } = await query;
            if (error) { showNotification("Não foi possível carregar clientes.", "error"); return; }
            const selectElement = document.getElementById('cliente-select-report');
            selectElement.innerHTML = '<option value="">Selecione um Cliente</option>';
            data.forEach(client => {
                const option = new Option(client.name, client.name);
                option.dataset.logo = client.logo_url || '';
                option.dataset.descricao = client.descricao_negocio || '';
                option.dataset.objetivo = client.objetivo_principal || '';
                option.dataset.publico = client.publico_alvo || '';
                selectElement.add(option);
            });
        }

        async function fetchSavedReports(clientName) {
            const listContainer = document.getElementById('saved-reports-list');
            const comparisonSelect = document.getElementById('comparison-report-select');
            const comparisonDiv = document.getElementById('comparison-selector-div');
            listContainer.innerHTML = '';
            comparisonSelect.innerHTML = '<option value="">Não comparar</option>';
            
            if (!clientName) { 
                document.getElementById('saved-reports-section').classList.add('hidden');
                comparisonDiv.classList.add('hidden');
                return;
            }

            document.getElementById('saved-reports-section').classList.remove('hidden');
            listContainer.innerHTML = '<div class="loader mx-auto"></div>';
            const { data, error } = await supabaseClient.from('relatorios_salvos')
                .select('id, mes_ano, created_at, raw_data')
                .eq('cliente_nome', clientName)
                .order('created_at', { ascending: false });

            if (error) { listContainer.innerHTML = `<p class="text-red-500">Erro ao buscar histórico: ${error.message}</p>`; return; }
            
            if (data.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 italic">Nenhum relatório salvo para este cliente.</p>';
                comparisonDiv.classList.add('hidden');
                return;
            }
            
            listContainer.innerHTML = data.map(report => {
                const date = new Date(report.created_at).toLocaleString('pt-BR');
                return `<button id="report-${report.id}" data-id="${report.id}" class="load-report-btn w-full text-left p-2 bg-white rounded-md hover:bg-indigo-50 transition">Relatório salvo em ${date}</button>`;
            }).join('');
            
            document.querySelectorAll('.load-report-btn').forEach(button => {
                button.addEventListener('click', () => loadSavedReport(button.dataset.id));
            });

            data.filter(report => report.raw_data).forEach(report => {
                const date = new Date(report.created_at).toLocaleString('pt-BR');
                comparisonSelect.add(new Option(`Relatório salvo em ${date}`, report.id));
            });
            comparisonDiv.classList.remove('hidden');
            
            highlightItemFromUrl();
        }

        function highlightItemFromUrl() {
            if (window.location.hash) {
                const elementId = window.location.hash.substring(1);
                const elementToHighlight = document.getElementById(elementId);
                if (elementToHighlight) {
                    elementToHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    elementToHighlight.classList.add('highlight');
                    setTimeout(() => {
                        elementToHighlight.classList.remove('highlight');
                    }, 2500);
                }
            }
        }
        
        async function loadSavedReport(reportId) {
            const { data, error } = await supabaseClient.from('relatorios_salvos')
                .select('raw_data')
                .eq('id', reportId)
                .single();

            if (error || !data || !data.raw_data) {
                showNotification('Erro: Não foi possível carregar os dados brutos deste relatório. Ele pode ser muito antigo ou ter sido salvo antes da atualização.', 'error');
                return;
            }
            
            lastGeneratedData = data.raw_data;
            
            const { cliente, logoUrl, monthYear, clippings, activities, overview, nextSteps } = lastGeneratedData;

            document.getElementById('cliente-select-report').value = cliente;
            document.getElementById('month-select-report').value = monthYear;
            document.getElementById('overview-input').value = overview;
            document.getElementById('next-steps-input').value = nextSteps;

            const nextStepsTextForUI = nextSteps.replace(/## (.*?)(?:\r\n|\r|\n)/g, '<h2>$1</h2>').replace(/### (.*?)(?:\r\n|\r|\n)/g, '<h3>$1</h3>').replace(/\*\s\*\*(.*?)\*\*/g, '<li><strong>$1</strong>').replace(/\*\s(.*?)(?:\r\n|\r|\n)/g, '<li>$1</li>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            updateReportUI(cliente, logoUrl, monthYear, clippings, activities, overview, nextStepsTextForUI);
            document.getElementById('report-editor-wrapper').classList.remove('hidden');
            showNotification('Relatório do histórico carregado com sucesso.', 'success');
        }

        async function saveReport() {
            const clienteName = document.getElementById('cliente-select-report').value;
            const monthYear = document.getElementById('month-select-report').value;
            const reportHtml = document.getElementById('report-editor').innerHTML;
            if (!clienteName || !monthYear || !reportHtml.trim() || !lastGeneratedData) {
                showNotification('Gere um relatório primeiro antes de salvar.', 'error');
                return;
            }
            const btn = document.getElementById('save-report-btn');
            btn.textContent = 'Salvando...';
            btn.disabled = true;
            const { error } = await supabaseClient.from('relatorios_salvos').insert({
                user_id: currentUser.id,
                cliente_nome: clienteName,
                mes_ano: monthYear,
                report_html: reportHtml,
                raw_data: lastGeneratedData
            });
            if (error) { 
                showNotification('Erro ao salvar: ' + error.message, 'error');
            } else { 
                showNotification('Pré-visualização e dados salvos com sucesso!', 'success');
                fetchSavedReports(clienteName);
            }
            btn.textContent = 'Salvar Pré-visualização';
            btn.disabled = false;
        }

        async function suggestWithAI(prompt, buttonId) {
            const btn = document.getElementById(buttonId);
            btn.innerHTML = '<div class="loader-small mx-auto"></div>';
            btn.disabled = true;
            try {
                const { data: invokeData, error: invokeError } = await supabaseClient.functions.invoke('generate-summary-ai', {
                    body: { prompt },
                });

                if (invokeError) throw new Error(`Erro na Edge Function: ${invokeError.message}`);
                if (invokeData.error) throw new Error(invokeData.error);

                return invokeData.candidates[0].content.parts[0].text;
            } finally {
                btn.innerHTML = 'Sugerir com IA';
                btn.disabled = false;
            }
        }

        async function suggestOverviewWithAI() {
            try {
                const clienteName = document.getElementById('cliente-select-report').value;
                const monthYear = document.getElementById('month-select-report').value;
                if (!clienteName || !monthYear) { throw new Error("Primeiro selecione um cliente e um mês."); }
                
                const [year, month] = monthYear.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1).toISOString();
                const endDate = new Date(year, month, 0, 23, 59, 59).toISOString();
                const monthNameCurrent = new Date(year, month - 1).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                
                const { data: clippingsCurrent, error } = await supabaseClient.from('clippings').select('*').eq('cliente', clienteName).gte('data_publicacao', startDate).lte('data_publicacao', endDate);
                if (error) throw error;
                const kpisCurrent = calculateHighlights({clippings: clippingsCurrent, activities: []});
                
                const comparisonId = document.getElementById('comparison-report-select').value;
                let prompt;

                if (comparisonId) {
                    const { data: comparisonReport } = await supabaseClient.from('relatorios_salvos').select('raw_data').eq('id', comparisonId).single();
                    if (!comparisonReport || !comparisonReport.raw_data) throw new Error("O relatório de comparação não contém dados brutos para análise.");
                    const dataA = comparisonReport.raw_data;
                    const kpisA = calculateHighlights(dataA);
                    const monthNameA = new Date(dataA.monthYear + '-02').toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                    prompt = `Você é um consultor de comunicação sênior. Sua tarefa é escrever um parágrafo de "Overview" **comparativo** para um relatório do cliente.\n**Cliente:** ${clienteName}\n**Período Anterior (${monthNameA}):**\n- Total de Matérias: ${kpisA.clippings}\n- Positivas: ${kpisA.positives}, Negativas: ${kpisA.negatives}, Neutras: ${kpisA.neutrals}\n**Período Atual (${monthNameCurrent}):**\n- Total de Matérias: ${kpisCurrent.clippings}\n- Positivas: ${kpisCurrent.positives}, Negativas: ${kpisCurrent.negatives}, Neutras: ${kpisCurrent.neutrals}\n\n**Instrução:** Gere um resumo executivo analisando a **evolução** entre os dois períodos. Destaque crescimentos, quedas e mudanças no sentimento da mídia. Seja profissional e objetivo.`;
                } else {
                    prompt = `Você é um consultor de comunicação. Sua tarefa é escrever um parágrafo de "Overview" para um relatório do cliente. Seja profissional e objetivo. Texto em Português do Brasil.\n\n**Cliente:** ${clienteName}\n**Período:** ${monthNameCurrent}\n\n**Dados:**\n- Total de Matérias: ${kpisCurrent.clippings}\n- Positivas: ${kpisCurrent.positives}, Negativas: ${kpisCurrent.negatives}, Neutras: ${kpisCurrent.neutrals}\n\n**Instrução:** Gere um resumo do mês destacando os principais resultados.`;
                }

                const suggestion = await suggestWithAI(prompt, 'suggest-overview-btn');
                document.getElementById('overview-input').value = suggestion;
                showNotification("Sugestão de overview gerada!", "success");
            } catch (error) {
                showNotification(`Erro ao gerar sugestão: ${error.message}`, "error");
            }
        }
        
        async function suggestNextStepsWithAI() {
            try {
                const clienteName = document.getElementById('cliente-select-report').value;
                const monthYear = document.getElementById('month-select-report').value;
                if (!clienteName || !monthYear) { throw new Error("Primeiro selecione um cliente e um mês."); }
                
                const [year, month] = monthYear.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1).toISOString();
                const endDate = new Date(year, month, 0, 23, 59, 59).toISOString();
                const { data: activitiesCurrent, error } = await supabaseClient.from('atividades').select('*').eq('cliente', clienteName).gte('data_atividade', startDate).lte('data_atividade', endDate);
                if (error) throw error;

                const comparisonId = document.getElementById('comparison-report-select').value;
                let prompt;

                if (comparisonId) {
                    const { data: comparisonReport } = await supabaseClient.from('relatorios_salvos').select('raw_data').eq('id', comparisonId).single();
                    if (!comparisonReport || !comparisonReport.raw_data) throw new Error("O relatório de comparação não contém dados brutos para análise.");
                    const plannedSteps = comparisonReport.raw_data.nextSteps || "Nenhum plano de ação definido no relatório anterior.";
                    const executedActivities = activitiesCurrent.map(a => `- ${a.tipo}: ${a.titulo}`).join('\n') || "Nenhuma atividade registrada no período atual.";
                    prompt = `Você é um consultor sênior. Sua tarefa é criar a seção "Próximos Passos" de um relatório, fazendo uma análise de "Planejamento vs. Execução".\n**Planejamento Anterior:**\n${plannedSteps}\n\n**Ações Executadas no Período Atual:**\n${executedActivities}\n\n**Instrução:** Com base no que foi planejado e no que foi executado, gere um texto em markdown com três seções:\n1.  Um título "## Análise de Execução e Resultados" com um breve parágrafo analisando se o plano anterior foi cumprido.\n2.  Um subtítulo "### O que foi Feito" listando as principais ações executadas.\n3.  Um subtítulo "### Planejamento para o Próximo Ciclo" com sugestões de 3 a 4 novos próximos passos, baseados na análise.`;
                } else {
                    prompt = `Você é um estratega de comunicação. Sugira uma lista de "Próximos Passos" para o cliente ${clienteName} para o próximo mês. Formate em markdown com títulos (###) e listas de itens (*).`;
                }
                
                const suggestion = await suggestWithAI(prompt, 'suggest-next-steps-btn');
                document.getElementById('next-steps-input').value = suggestion;
                showNotification("Sugestão de próximos passos gerada!", "success");
            } catch (error) {
                showNotification(`Erro ao gerar sugestão: ${error.message}`, "error");
            }
        }
        
        async function generateReport() {
            const clienteSelect = document.getElementById('cliente-select-report');
            const clienteName = clienteSelect.value;
            const monthYear = document.getElementById('month-select-report').value;
            if (!clienteName || !monthYear) { showNotification("Selecione um cliente e um mês.", "error"); return; }
            const btn = document.getElementById('generate-report-btn');
            btn.textContent = "Gerando...";
            btn.disabled = true;
            const selectedOption = clienteSelect.options[clienteSelect.selectedIndex];
            const selectedClientLogo = selectedOption.dataset.logo;
            const overviewText = document.getElementById('overview-input').value;
            const nextStepsContent = document.getElementById('next-steps-input').value;
            
            const [year, month] = monthYear.split('-').map(Number);
            const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
            const endDate = new Date(year, month, 0).toISOString().split('T')[0];
            try {
                const clippingsQuery = supabaseClient.from('clippings').select('*').eq('cliente', clienteName).gte('data_publicacao', startDate).lte('data_publicacao', endDate);
                const activitiesQuery = supabaseClient.from('atividades').select('*').eq('cliente', clienteName).gte('data_atividade', startDate).lte('data_atividade', endDate);
                const [clippingsResult, activitiesResult] = await Promise.all([ clippingsQuery, activitiesQuery ]);
                if (clippingsResult.error) throw clippingsResult.error;
                if (activitiesResult.error) throw activitiesResult.error;
                
                lastGeneratedData = {
                    cliente: clienteName, logoUrl: selectedClientLogo, monthYear: monthYear,
                    overview: overviewText, nextSteps: nextStepsContent,
                    clippings: clippingsResult.data, activities: activitiesResult.data
                };
                
                const nextStepsTextForUI = nextStepsContent.replace(/## (.*?)(?:\r\n|\r|\n)/g, '<h2>$1</h2>').replace(/### (.*?)(?:\r\n|\r|\n)/g, '<h3>$1</h3>').replace(/\*\s\*\*(.*?)\*\*/g, '<li><strong>$1</strong>').replace(/\*\s(.*?)(?:\r\n|\r|\n)/g, '<li>$1</li>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                updateReportUI(clienteName, selectedClientLogo, monthYear, clippingsResult.data, activitiesResult.data, overviewText, nextStepsTextForUI);
                document.getElementById('report-editor-wrapper').classList.remove('hidden');
            } catch (error) {
                showNotification("Falha ao gerar relatório: " + error.message, "error");
            } finally {
                btn.textContent = "Gerar Relatório e Pré-visualizar";
                btn.disabled = false;
            }
        }
        
        function updateReportUI(clienteName, logoUrl, monthYear, clippings, activities, overviewText, nextStepsText) {
            const editor = document.getElementById('report-editor');
            const [year, month] = monthYear.split('-');
            const monthName = new Date(year, parseInt(month) - 1).toLocaleString('pt-BR', { month: 'long' });
            const highlights = calculateHighlights({clippings, activities});
            editor.innerHTML = `
                <div id="report-cover" class="text-center p-10">
                    ${logoUrl ? `<img src="${logoUrl}" alt="Logótipo" class="max-h-24 mx-auto object-contain mb-6">` : '<div class="h-24"></div>'}
                    <h1 class="text-4xl font-bold text-gray-800">${clienteName}</h1>
                    <p class="text-xl mt-2 text-gray-600">Relatório de Atividades e Clipping - ${monthName.charAt(0).toUpperCase() + monthName.slice(1)} de ${year}</p>
                </div>
                <div class="page-break"><h2>Overview</h2><div>${overviewText.replace(/\n/g, '<br>')}</div></div>
                <div class="page-break"><h2>Destaques</h2><div id="report-highlights" class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-center"></div></div>
                <div class="page-break">
                    <h2>Análise de Mídia</h2>
                    <div class="p-4 rounded-lg bg-gray-50 mb-8"><h3>Matérias por Classificação</h3><div class="relative h-80"><canvas id="classificationChart"></canvas></div></div>
                    <div class="p-4 rounded-lg bg-gray-50 mb-8"><h3>Top 5 Veículos</h3><div class="relative h-80"><canvas id="topVehiclesChart"></canvas></div></div>
                    <div class="p-4 rounded-lg bg-gray-50"><h3>Evolução no Mês</h3><div class="relative h-80"><canvas id="monthlyTrendChart"></canvas></div></div>
                </div>
                <div class="page-break"><h2>Atividades Realizadas</h2><div id="report-activities-content"></div></div>
                <div class="page-break"><h2>Clipping Detalhado</h2><div id="report-clippings-list" class="space-y-4"></div></div>
                <div class="page-break"><h2>Próximos Passos</h2><div class="report-content-steps">${nextStepsText.replace(/\n/g, '<br>')}</div></div>
            `;
            setTimeout(() => {
                renderHighlights(highlights);
                createCharts(clippings, year, parseInt(month));
                renderActivitiesList(activities);
                renderClippingsList(clippings);
            }, 100);
        }
        
        function calculateHighlights(data) {
            const clippings = data.clippings || [];
            const activities = data.activities || [];
            return {
                clippings: clippings.length,
                positives: clippings.filter(c => c.classificacao === 'Positiva').length,
                negatives: clippings.filter(c => c.classificacao === 'Negativa').length,
                neutrals: clippings.filter(c => c.classificacao === 'Neutra').length,
                activities: activities.length
            };
        }
        
        function renderHighlights(highlights) {
            const container = document.getElementById('report-highlights');
            if (!container) return;
            container.innerHTML = `
                <div class="bg-blue-100 p-4 rounded-lg"><p class="text-3xl font-bold text-blue-800">${highlights.clippings}</p><p class="text-sm text-blue-600">Matérias</p></div>
                <div class="bg-green-100 p-4 rounded-lg"><p class="text-3xl font-bold text-green-800">${highlights.positives}</p><p class="text-sm text-green-600">Positivas</p></div>
                <div class="bg-red-100 p-4 rounded-lg"><p class="text-3xl font-bold text-red-800">${highlights.negatives}</p><p class="text-sm text-red-600">Negativas</p></div>
                <div class="bg-purple-100 p-4 rounded-lg"><p class="text-3xl font-bold text-purple-800">${highlights.activities}</p><p class="text-sm text-purple-600">Atividades</p></div>
            `;
        }

        function createCharts(data, year, month, callback) {
            Object.values(chartInstances).forEach(chart => chart.destroy());
            const chartsToRender = 3;
            let chartsRendered = 0;
            const onComplete = () => { chartsRendered++; if (chartsRendered >= chartsToRender && callback) callback(); };
            const classCtx = document.getElementById('classificationChart')?.getContext('2d');
            const vehicleCtx = document.getElementById('topVehiclesChart')?.getContext('2d');
            const monthlyCtx = document.getElementById('monthlyTrendChart')?.getContext('2d');
            if (!classCtx || !vehicleCtx || !monthlyCtx) { if (callback) callback(); return; }
            const classData = { Positiva: 0, Negativa: 0, Neutra: 0 };
            data.forEach(c => { if(classData.hasOwnProperty(c.classificacao)) classData[c.classificacao]++; });
            chartInstances.classification = new Chart(classCtx, { type: 'doughnut', data: { labels: Object.keys(classData), datasets: [{ data: Object.values(classData), backgroundColor: ['#22c55e', '#ef4444', '#f59e0b'] }] }, options: { animation: { onComplete }, responsive: true, maintainAspectRatio: false } });
            const vehicleCounts = data.reduce((acc, c) => { acc[c.veiculo] = (acc[c.veiculo] || 0) + 1; return acc; }, {});
            const topVehicles = Object.entries(vehicleCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            chartInstances.topVehicles = new Chart(vehicleCtx, { type: 'bar', data: { labels: topVehicles.map(v => v[0]), datasets: [{ label: 'Matérias', data: topVehicles.map(v => v[1]), backgroundColor: '#8b5cf6' }] }, options: { indexAxis: 'y', animation: { onComplete }, responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            const daysInMonth = new Date(year, month, 0).getDate();
            const dailyCounts = Array(daysInMonth).fill(0);
            data.forEach(c => { const day = new Date(c.data_publicacao).getUTCDate() - 1; if(day >= 0 && day < daysInMonth) dailyCounts[day]++; });
            chartInstances.monthly = new Chart(monthlyCtx, { type: 'line', data: { labels: Array.from({length: daysInMonth}, (_, i) => i + 1), datasets: [{ label: 'Matérias por Dia', data: dailyCounts, borderColor: '#3b82f6', tension: 0.1 }] }, options: { animation: { onComplete }, responsive: true, maintainAspectRatio: false } });
        }
        
        function renderActivitiesList(activities) {
            const container = document.getElementById('report-activities-content');
            if(!container) return;
            if(activities.length === 0){ container.innerHTML = '<p>Nenhuma atividade registrada neste mês.</p>'; return; }
            activities.sort((a, b) => new Date(a.data_atividade) - new Date(b.data_atividade));
            container.innerHTML = '<ul>' + activities.map(a => {
                const date = new Date(a.data_atividade);
                date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                return `<li><strong>[${date.toLocaleDateString('pt-BR')}] ${a.tipo}:</strong> ${a.titulo}</li>`;
            }).join('') + '</ul>';
        }

        function renderClippingsList(clippings) {
            const container = document.getElementById('report-clippings-list');
            if(!container) return;
            if(clippings.length === 0){ container.innerHTML = '<p>Nenhum clipping encontrado neste mês.</p>'; return; }
            container.innerHTML = '';
            clippings.sort((a, b) => new Date(a.data_publicacao) - new Date(b.data_publicacao));
            clippings.forEach(c => {
                const card = document.createElement('div');
                card.className = 'p-4 border rounded-lg mb-4';
                const date = new Date(c.data_publicacao);
                date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                card.innerHTML = `<h4 class="font-bold">${c.titulo}</h4><p class="text-sm"><strong>Veículo:</strong> ${c.veiculo} | <strong>Data:</strong> ${date.toLocaleDateString('pt-BR')} | <strong>Classificação:</strong> ${c.classificacao}</p>` +
                                (c.link ? `<a href="${c.link}" target="_blank" class="text-sm text-blue-500 hover:underline">Ver online</a>` : '') +
                                (c.image_url ? `<img src="${c.image_url}" class="mt-2 max-w-xs h-auto rounded cursor-pointer report-image">` : '');
                container.appendChild(card);
            });
            document.querySelectorAll('.report-image').forEach(img => {
                img.addEventListener('click', e => {
                    document.getElementById('modal-image').src = e.target.src;
                    document.getElementById('image-modal').classList.remove('hidden');
                });
            });
        }
        
        async function exportToPDFwithPdfMake() {
            if (!lastGeneratedData) { showNotification("Gere um relatório primeiro para exportar.", "error"); return; }
            const btn = document.getElementById('export-pdf-btn');
            btn.textContent = 'Preparando PDF...'; btn.disabled = true;
            try {
                const { cliente, logoUrl, monthYear, overview, nextSteps, clippings, activities } = lastGeneratedData;
                const [year, month] = monthYear.split('-');
                const monthName = new Date(year, parseInt(month) - 1).toLocaleString('pt-BR', { month: 'long' });
                const classificationChartImg = chartInstances.classification ? chartInstances.classification.toBase64Image() : null;
                const topVehiclesChartImg = chartInstances.topVehicles ? chartInstances.topVehicles.toBase64Image() : null;
                const monthlyTrendChartImg = chartInstances.monthly ? chartInstances.monthly.toBase64Image() : null;
                const highlights = calculateHighlights({clippings, activities});

                const nextStepsFormatted = [];
                if (nextSteps) {
                    const lines = nextSteps.split('\n').filter(line => line.trim() !== '');
                    for(const line of lines) {
                        if (line.startsWith('## ')) { nextStepsFormatted.push({ text: line.replace('## ', ''), style: 'h3', margin: [0, 10, 0, 5] }); } 
                        else if (line.startsWith('### ')) { nextStepsFormatted.push({ text: line.replace('### ', ''), style: 'h4', margin: [0, 8, 0, 4] }); } 
                        else if (line.startsWith('* **')) { const match = line.match(/^\*\s\*\*(.*?)\*\*(.*)/); if(match){ nextStepsFormatted.push({ ul: [ { text: [ { text: match[1], bold: true }, { text: match[2] } ] } ] }); } } 
                        else if (line.startsWith('* ')) { nextStepsFormatted.push({ ul: [ line.replace('* ', '') ]}); } 
                        else if (line.startsWith('**')) { const match = line.match(/^\*\*(.*?)\*\*(.*)/); if(match){ nextStepsFormatted.push({ text: [ { text: match[1], bold: true }, { text: match[2] } ], margin: [0, 5, 0, 5]}); } } 
                        else { nextStepsFormatted.push({ text: line, style: 'p' }); }
                    }
                }
                
                const detailedClippingsContent = await Promise.all(
                    clippings.map(async c => {
                        const date = new Date(c.data_publicacao); date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                        const clippingImage = c.image_url ? await toDataURL(c.image_url) : null;
                        const contentStack = [
                            { text: c.titulo, style: 'clippingTitle' },
                            { text: `Veículo: ${c.veiculo} | Data: ${date.toLocaleDateString('pt-BR')} | Classificação: ${c.classificacao}`, style: 'clippingMeta'},
                            c.link ? { text: 'Ver online', link: c.link, style: 'link' } : {}
                        ];
                        if(clippingImage) { contentStack.push({ image: clippingImage, width: 400, alignment: 'center', margin: [0, 5, 0, 0] }); }
                        return { stack: contentStack, margin: [0, 0, 0, 15] };
                    })
                );

                const docDefinition = {
                    pageSize: 'A4', pageMargins: [ 40, 60, 40, 60 ],
                    content: [
                        { image: logoUrl ? await toDataURL(logoUrl) : null, width: 150, alignment: 'center', margin: [0, 50, 0, 20] },
                        { text: cliente, style: 'h1', alignment: 'center' },
                        { text: `Relatório de Atividades e Clipping`, style: 'subheader', alignment: 'center' },
                        { text: `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} de ${year}`, style: 'subheader', alignment: 'center', margin: [0, 0, 0, 100] },
                        { text: 'Overview', style: 'h2', pageBreak: 'before' },
                        { text: overview || 'Nenhum overview fornecido.', style: 'p' },
                        { text: 'Destaques', style: 'h2', margin: [0, 20, 0, 10] },
                        { layout: 'noBorders', table: { widths: ['*', '*', '*', '*'], body: [ [ { text: [{ text: `${highlights.clippings}\n`, style: 'highlightNumber' }, { text: 'Matérias', style: 'highlightText' }], style: 'highlightBox', fillColor: '#e0f2fe' }, { text: [{ text: `${highlights.positives}\n`, style: 'highlightNumber' }, { text: 'Positivas', style: 'highlightText' }], style: 'highlightBox', fillColor: '#dcfce7' }, { text: [{ text: `${highlights.negatives}\n`, style: 'highlightNumber' }, { text: 'Negativas', style: 'highlightText' }], style: 'highlightBox', fillColor: '#fee2e2' }, { text: [{ text: `${highlights.activities}\n`, style: 'highlightNumber' }, { text: 'Atividades', style: 'highlightText' }], style: 'highlightBox', fillColor: '#f3e8ff' } ] ] } },
                        { text: 'Análise de Mídia', style: 'h2', margin: [0, 20, 0, 10] },
                        { text: 'Matérias por Classificação', style: 'h3' },
                        classificationChartImg ? { image: classificationChartImg, width: 450, alignment: 'center' } : {text: 'Gráfico indisponível.'},
                        { text: 'Top 5 Veículos', style: 'h3' },
                        topVehiclesChartImg ? { image: topVehiclesChartImg, width: 450, alignment: 'center' } : {text: 'Gráfico indisponível.'},
                        { text: 'Evolução no Mês', style: 'h3' },
                        monthlyTrendChartImg ? { image: monthlyTrendChartImg, width: 450, alignment: 'center' } : {text: 'Gráfico indisponível.'},
                        { text: 'Atividades Realizadas', style: 'h2', pageBreak: 'before' },
                        activities.length > 0 ? { ul: activities.map(a => { const date = new Date(a.data_atividade); date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); return { text: [ { text: `[${date.toLocaleDateString('pt-BR')}] ${a.tipo}: `, bold: true }, `${a.titulo}`]}; }) } : { text: 'Nenhuma atividade registrada no período.', style: 'p', italics: true },
                        { text: 'Clipping Detalhado', style: 'h2', pageBreak: 'before' }, ...detailedClippingsContent,
                        { text: 'Próximos Passos', style: 'h2', pageBreak: 'before' }, ...nextStepsFormatted,
                    ],
                    styles: {
                        h1: { fontSize: 24, bold: true, margin: [0, 0, 0, 10] },
                        h2: { fontSize: 18, bold: true, margin: [0, 15, 0, 10], color: '#111827', border: [false, false, false, true] },
                        h3: { fontSize: 14, bold: true, margin: [0, 15, 0, 5], color: '#374151' },
                        h4: { fontSize: 12, bold: true, margin: [0, 12, 0, 5], color: '#374151' },
                        p: { fontSize: 10, lineHeight: 1.4 }, link: { fontSize: 10, color: 'blue', decoration: 'underline' },
                        clippingTitle: { fontSize: 11, bold: true, margin: [0, 0, 0, 2] },
                        clippingMeta: { fontSize: 9, italics: true, color: '#4b5563' },
                        highlightBox: { margin: 5, alignment: 'center' },
                        highlightNumber: { fontSize: 22, bold: true, color: '#1e3a8a' },
                        highlightText: { fontSize: 9, color: '#6b7280' },
                    },
                    defaultStyle: { font: 'Roboto', fontSize: 10, lineHeight: 1.15 }
                };
                pdfMake.createPdf(docDefinition).download(`relatorio_${cliente.replace(/\s+/g, '-')}_${monthYear}.pdf`);
            } catch (error) {
                console.error("Erro ao gerar PDF com pdfmake:", error);
                showNotification("Erro ao gerar o PDF. Verifique o console para detalhes.", "error");
            } finally {
                btn.textContent = 'Exportar para PDF'; btn.disabled = false;
            }
        }

        async function toDataURL(url) {
            try {
                const response = await fetch(url, { cache: 'reload' });
                const blob = await response.blob();
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (e) {
                console.warn(`Não foi possível carregar a imagem da URL: ${url}.`, e);
                return null;
            }
        }
        
        handleAuth();
    </script>
</body>
</html>